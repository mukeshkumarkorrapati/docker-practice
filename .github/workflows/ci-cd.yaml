name: Build Push Deploy to Cloudsmith + ArgoCD

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set image tag (timestamp)
        run: echo "IMAGE_TAG=$(date +%s)" >> $GITHUB_ENV

      - name: Login to Cloudsmith
        run: |
          echo ${{ secrets.CLOUDSMITH_API_KEY }} | \
          docker login docker.cloudsmith.io \
          -u ${{ secrets.CLOUDSMITH_USERNAME }} --password-stdin

      - name: Build Docker image
        run: |
          docker build -t myapp:${{ env.IMAGE_TAG }} .

      - name: Tag image for Cloudsmith
        run: |
          docker tag myapp:${{ env.IMAGE_TAG }} \
          ${{ secrets.CLOUDSMITH_REPO }}/myapp:${{ env.IMAGE_TAG }}

      - name: Push to Cloudsmith
        run: |
          docker push ${{ secrets.CLOUDSMITH_REPO }}/myapp:${{ env.IMAGE_TAG }}

      - name: Update image tag in Kubernetes manifest
        run: |
          sed -i "s|PLACEHOLDER_TAG|${{ env.IMAGE_TAG }}|" \
          k8s/webapp.yaml

      - name: Commit updated manifest back to GitHub
        run: |
          git config --global user.email "ci-bot@example.com"
          git config --global user.name "ci-bot"
          git add k8s/webapp.yaml
          git commit -m "Update image to ${{ env.IMAGE_TAG }}"
          git push origin main
